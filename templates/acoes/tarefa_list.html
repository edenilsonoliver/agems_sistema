{% extends 'components/list_view.html' %}

{% block header_actions %}
<a href="{% url 'tarefa_calendario' %}" class="btn btn-outline-primary">
    <i class="bi bi-calendar3"></i> Ver Cronograma
</a>
{% endblock %}

{% block content %}
{{ block.super }}

<script>
document.addEventListener("DOMContentLoaded", function() {
  // Cria o bot칚o dinamicamente ap칩s o carregamento da p치gina
  const headerDiv = document.querySelector(".page-header .d-flex > div:last-child");
  if (headerDiv) {
    const btn = document.createElement("a");
    btn.href = "{% url 'tarefa_calendario' %}";
    btn.className = "btn btn-outline-primary me-2";
    btn.innerHTML = '<i class="bi bi-calendar3"></i> Ver Calend치rio';
    headerDiv.prepend(btn);
  }
});
</script>
{% endblock %}


{% block extra_buttons %}
<a href="{% url 'tarefa_calendario' %}" class="btn btn-outline-primary btn-sm">
    <i class="bi bi-calendar3"></i> Ver Calend치rio
</a>
{% endblock %}


{% block extra_filters %}
<div class="col-md-3">
    <select name="instrumento" id="instrumento" class="form-select" style="height: 40px;">
        <option value="">游댌 Filtrar por Instrumento...</option>
        {% for inst in instrumentos %}
            <option value="{{ inst.id }}" {% if instrumento_selecionado == inst.id|stringformat:"s" %}selected{% endif %}>
                {{ inst }}
            </option>
        {% endfor %}
    </select>
</div>

<div class="col-md-3">
    <select name="obrigacao" id="obrigacao" class="form-select" style="height: 40px;">
        <option value="">游댌 Filtrar por Obriga칞칚o...</option>
        {% for obrigacao in obrigacoes %}
            <option value="{{ obrigacao.id }}" {% if obrigacao_selecionada == obrigacao.id|stringformat:"s" %}selected{% endif %}>
                {{ obrigacao.titulo }}
            </option>
        {% endfor %}
    </select>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const instrumentoSelect = document.getElementById("instrumento");
    const obrigacaoSelect = document.getElementById("obrigacao");

    instrumentoSelect.addEventListener("change", async function() {
        const instrumentoId = this.value;
        obrigacaoSelect.innerHTML = '<option value="">Carregando...</option>';

        if (!instrumentoId) {
            obrigacaoSelect.innerHTML = '<option value="">游댌 Filtrar por Obriga칞칚o...</option>';
            return;
        }

        const response = await fetch(`/tarefas/obrigacoes/?instrumento_id=${instrumentoId}`);
        const data = await response.json();

        obrigacaoSelect.innerHTML = '<option value="">游댌 Filtrar por Obriga칞칚o...</option>';
        data.obrigacoes.forEach(o => {
            const opt = document.createElement('option');
            opt.value = o.id;
            opt.textContent = o.titulo;
            obrigacaoSelect.appendChild(opt);
        });
    });
});
</script>
{% endblock %}


{% block table_headers %}
<th>Nome</th>
<th>A칞칚o</th>
<th>Respons치vel</th>
<th>Per칤odo</th>
<th>Progresso</th>
<th>Status</th>
{% endblock %}

{% block table_rows %}
{% for tarefa in object_list %}
<tr>
    <td>
        <!-- Nome da Tarefa (clic치vel para expandir checklist) -->
        <div class="fw-semibold toggle-checklist" data-tarefa="{{ tarefa.id }}" style="cursor:pointer;">
            {{ tarefa.nome }}
        </div>
        <small class="text-muted">
            <i class="bi bi-flag me-1"></i>
            {{ tarefa.get_prioridade_display }}
        </small>

        <!-- Checklist oculto -->
        <div class="checklist collapse mt-2" id="checklist-{{ tarefa.id }}">
            {% if tarefa.checklist_itens.exists %}
                {% for item in tarefa.checklist_itens.all %}
                    <div class="d-flex align-items-center mb-1">
                        <input type="checkbox" {% if item.concluido %}checked{% endif %} disabled class="me-2">
                        <small>{{ item.nome }}</small>
                    </div>
                {% endfor %}
            {% else %}
                <small class="text-muted">Sem checklist</small>
            {% endif %}
        </div>
    </td>

    <td><small>{{ tarefa.acao.nome }}</small></td>
    <td><small>{{ tarefa.responsavel.get_full_name|default:tarefa.responsavel.username }}</small></td>
    <td>
        <small><i class="bi bi-calendar me-1"></i>
        {{ tarefa.data_inicio|date:"d/m/Y" }} - {{ tarefa.data_fim|date:"d/m/Y" }}</small>
    </td>
    <td>
        <div class="progress" style="height: 20px;">
            <div class="progress-bar" role="progressbar" style="width: {{ tarefa.percentual_cumprido }}%">
                {{ tarefa.percentual_cumprido }}%
            </div>
        </div>
    </td>
    <td>
        {% if tarefa.status == 'finalizado' %}
            <span class="badge bg-success">Finalizado</span>
        {% elif tarefa.status == 'em_andamento' %}
            <span class="badge bg-primary">Em Andamento</span>
        {% elif tarefa.status == 'atrasado' %}
            <span class="badge bg-danger">Atrasado</span>
        {% else %}
            <span class="badge bg-secondary">{{ tarefa.get_status_display }}</span>
        {% endif %}
    </td>
    <td>
        <div class="btn-group btn-group-sm">
            <a href="{% url 'tarefa_edit' tarefa.pk %}" class="btn btn-outline-primary" title="Editar">
                <i class="bi bi-pencil"></i>
            </a>
            <a href="{% url 'tarefa_delete' tarefa.pk %}" class="btn btn-outline-danger" title="Excluir">
                <i class="bi bi-trash"></i>
            </a>
        </div>
    </td>
</tr>
{% endfor %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll('.toggle-checklist').forEach(btn => {
        btn.addEventListener('click', () => {
            const id = btn.getAttribute('data-tarefa');
            const checklist = document.getElementById(`checklist-${id}`);
            checklist.classList.toggle('show');
        });
    });
});
</script>
{% endblock %}
