{% extends 'components/form_view.html' %}
{% load crispy_forms_tags %}

{% block form_content %}
    {# Renderizar campos individuais ao invés de {{ form|crispy }} #}
    
    {# Nome da Tarefa #}
    {{ form.nome|as_crispy_field }}
    
    {# Descrição #}
    {{ form.descricao|as_crispy_field }}
    
    {# Ação #}
    {{ form.acao|as_crispy_field }}
    
    {# Responsável #}
    {{ form.responsavel|as_crispy_field }}
    
    {# Executores #}
    {{ form.executores|as_crispy_field }}
    
    {# Status #}
    {{ form.status|as_crispy_field }}
    
    {# Percentual Cumprido #}
    {{ form.percentual_cumprido|as_crispy_field }}
    
    {# CAMPOS DE DATA - RENDERIZAÇÃO MANUAL #}
    <div class="mb-3">
        <label for="{{ form.data_inicio.id_for_label }}" class="form-label">
            Data de Início<span class="text-danger">*</span>
        </label>
        <input type="text" 
               name="{{ form.data_inicio.html_name }}" 
               id="{{ form.data_inicio.id_for_label }}"
               value="{{ form.data_inicio.value|default:'' }}"
               class="form-control date-mask" 
               placeholder="dd/mm/aaaa"
               maxlength="10"
               required>
        {% if form.data_inicio.help_text %}
            <small class="form-text text-muted">{{ form.data_inicio.help_text }}</small>
        {% endif %}
        {% if form.data_inicio.errors %}
            <div class="invalid-feedback d-block">
                {{ form.data_inicio.errors }}
            </div>
        {% endif %}
    </div>
    
    <div class="mb-3">
        <label for="{{ form.data_fim.id_for_label }}" class="form-label">
            Data de Fim<span class="text-danger">*</span>
        </label>
        <input type="text" 
               name="{{ form.data_fim.html_name }}" 
               id="{{ form.data_fim.id_for_label }}"
               value="{{ form.data_fim.value|default:'' }}"
               class="form-control date-mask" 
               placeholder="dd/mm/aaaa"
               maxlength="10"
               required>
        {% if form.data_fim.help_text %}
            <small class="form-text text-muted">{{ form.data_fim.help_text }}</small>
        {% endif %}
        {% if form.data_fim.errors %}
            <div class="invalid-feedback d-block">
                {{ form.data_fim.errors }}
            </div>
        {% endif %}
    </div>
    
    <div class="mb-3">
        <label for="{{ form.data_conclusao.id_for_label }}" class="form-label">
            Data de Conclusão Real
        </label>
        <input type="text" 
               name="{{ form.data_conclusao.html_name }}" 
               id="{{ form.data_conclusao.id_for_label }}"
               value="{{ form.data_conclusao.value|default:'' }}"
               class="form-control date-mask" 
               placeholder="dd/mm/aaaa"
               maxlength="10">
        {% if form.data_conclusao.help_text %}
            <small class="form-text text-muted">{{ form.data_conclusao.help_text }}</small>
        {% endif %}
        {% if form.data_conclusao.errors %}
            <div class="invalid-feedback d-block">
                {{ form.data_conclusao.errors }}
            </div>
        {% endif %}
    </div>
    
    {# Tarefas Predecessoras #}
    {{ form.tarefas_predecessoras|as_crispy_field }}
    
    {# Prioridade #}
    {{ form.prioridade|as_crispy_field }}
    
    {# Observações #}
    {{ form.observacoes|as_crispy_field }}

    <hr class="my-4">

    <h5 class="mt-3">
        <i class="bi bi-list-check me-2"></i> Checklist da Tarefa
    </h5>

    <!-- Botão para mostrar/criar checklist -->
    <div id="checklist-toggle-container" {% if checklist_formset.forms %}style="display: none;"{% endif %}>
        <button type="button" class="btn btn-sm btn-outline-primary" id="show-checklist-btn">
            <i class="bi bi-plus-circle me-1"></i> Adicionar Checklist
        </button>
    </div>

    <!-- Container do checklist -->
    <div id="checklist-container" {% if not checklist_formset.forms %}style="display: none;"{% endif %}>
        {{ checklist_formset.management_form }}
        
        <div id="checklist-items">
            {% for form in checklist_formset %}
                <div class="checklist-item mb-2 d-flex align-items-center gap-2" data-form-index="{{ forloop.counter0 }}">
                    {{ form.id }}
                    
                    <!-- Campo nome -->
                    <input type="text" 
                           name="{{ form.nome.html_name }}" 
                           id="{{ form.nome.id_for_label }}"
                           value="{{ form.nome.value|default:'' }}"
                           class="form-control" 
                           placeholder="Item do checklist">
                    
                    <!-- Campo concluído -->
                    <div class="form-check">
                        <input type="checkbox" 
                               name="{{ form.concluido.html_name }}"
                               id="{{ form.concluido.id_for_label }}"
                               class="form-check-input"
                               {% if form.concluido.value %}checked{% endif %}>
                        <label class="form-check-label small text-muted" for="{{ form.concluido.id_for_label }}">
                            Concluído
                        </label>
                    </div>
                    
                    <!-- Campo DELETE (oculto mas funcional) -->
                    <input type="checkbox" 
                           name="{{ form.DELETE.html_name }}"
                           id="{{ form.DELETE.id_for_label }}"
                           class="d-none"
                           {% if form.DELETE.value %}checked{% endif %}>
                    
                    <!-- Botão remover -->
                    <button type="button" class="btn btn-sm btn-outline-danger remove-checklist-item" title="Remover item">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            {% endfor %}
        </div>
        
        <button type="button" class="btn btn-sm btn-outline-secondary mt-2" id="add-checklist-item">
            <i class="bi bi-plus me-1"></i> Adicionar item
        </button>
    </div>

    <script>
        (function() {
            console.log('=== CHECKLIST SCRIPT V3 INICIADO ===');

            const container = document.getElementById('checklist-container');
            const toggleContainer = document.getElementById('checklist-toggle-container');
            const showBtn = document.getElementById('show-checklist-btn');
            const addBtn = document.getElementById('add-checklist-item');
            const itemsContainer = document.getElementById('checklist-items');
            const totalFormsInput = document.querySelector('input[name="checklist_itens-TOTAL_FORMS"]');

            if (container && toggleContainer && showBtn && addBtn && itemsContainer && totalFormsInput) {
                console.log('Elementos encontrados. Total forms:', totalFormsInput.value);

                // Mostrar checklist ao clicar no botão
                showBtn.addEventListener('click', function() {
                    container.style.display = 'block';
                    toggleContainer.style.display = 'none';
                    addNewChecklistItem();
                });

                // Adicionar novo item
                addBtn.addEventListener('click', function() {
                    addNewChecklistItem();
                });

                // Remover item (event delegation)
                itemsContainer.addEventListener('click', function(e) {
                    const removeBtn = e.target.closest('.remove-checklist-item');
                    if (removeBtn) {
                        e.preventDefault();
                        console.log('Botão lixeira clicado');
                        
                        const item = removeBtn.closest('.checklist-item');
                        const isNew = item.getAttribute('data-is-new') === 'true';
                        
                        console.log('Item é novo?', isNew);
                        
                        if (!isNew) {
                            // Item existente: marcar DELETE e ocultar
                            const deleteCheckbox = item.querySelector('input[name$="-DELETE"]');
                            if (deleteCheckbox) {
                                deleteCheckbox.checked = true;
                                console.log('DELETE marcado como true');
                            }
                            // Forçar ocultação com !important
                            item.style.setProperty('display', 'none', 'important');
                            console.log('Item ocultado! Display:', item.style.display);
                        } else {
                            // Item novo: remover do DOM
                            console.log('Removendo item novo');
                            item.remove();
                            reindexForms();
                            console.log('Item removido!');
                        }
                    }
                });

                // Função para adicionar novo item
                function addNewChecklistItem() {
                    const newIndex = parseInt(totalFormsInput.value);
                    const prefix = 'checklist_itens';
                    
                    console.log('Criando item com index:', newIndex);
                    
                    const newItemDiv = document.createElement('div');
                    newItemDiv.className = 'checklist-item mb-2 d-flex align-items-center gap-2';
                    newItemDiv.setAttribute('data-form-index', newIndex);
                    newItemDiv.setAttribute('data-is-new', 'true');
                    
                    newItemDiv.innerHTML = `
                        <input type="text" 
                               name="${prefix}-${newIndex}-nome" 
                               id="id_${prefix}-${newIndex}-nome"
                               class="form-control" 
                               placeholder="Item do checklist">
                        
                        <div class="form-check">
                            <input type="checkbox" 
                                   name="${prefix}-${newIndex}-concluido"
                                   id="id_${prefix}-${newIndex}-concluido"
                                   class="form-check-input">
                            <label class="form-check-label small text-muted" for="id_${prefix}-${newIndex}-concluido">
                                Concluído
                            </label>
                        </div>
                        
                        <button type="button" class="btn btn-sm btn-outline-danger remove-checklist-item" title="Remover item">
                            <i class="bi bi-trash"></i>
                        </button>
                    `;
                    
                    itemsContainer.appendChild(newItemDiv);
                    totalFormsInput.value = newIndex + 1;
                    
                    console.log('Item adicionado. Novo total:', totalFormsInput.value);
                }

                // Função para reindexar formulários após remoção
                function reindexForms() {
                    const prefix = 'checklist_itens';
                    const allItems = itemsContainer.querySelectorAll('.checklist-item');
                    const existingItems = Array.from(allItems).filter(item => !item.hasAttribute('data-is-new'));
                    const visibleNewItems = Array.from(allItems).filter(item => 
                        item.hasAttribute('data-is-new') && item.style.display !== 'none'
                    );
                    
                    const existingItemsCount = existingItems.length;
                    
                    visibleNewItems.forEach((item, index) => {
                        const newIndex = existingItemsCount + index;
                        item.setAttribute('data-form-index', newIndex);
                        
                        const nameInput = item.querySelector('input[type="text"]');
                        if (nameInput) {
                            nameInput.name = `${prefix}-${newIndex}-nome`;
                            nameInput.id = `id_${prefix}-${newIndex}-nome`;
                        }
                        
                        const checkboxInput = item.querySelector('input[type="checkbox"]');
                        if (checkboxInput) {
                            checkboxInput.name = `${prefix}-${newIndex}-concluido`;
                            checkboxInput.id = `id_${prefix}-${newIndex}-concluido`;
                        }
                        
                        const label = item.querySelector('label');
                        if (label) {
                            label.setAttribute('for', `id_${prefix}-${newIndex}-concluido`);
                        }
                    });
                    
                    const totalItems = existingItemsCount + visibleNewItems.length;
                    totalFormsInput.value = totalItems;
                    
                    console.log('Reindexação completa. Total:', totalItems);
                }

                console.log('=== CHECKLIST SCRIPT V3 PRONTO ===');
            }
        })();

        // === MÁSCARA DE DATA (dd/mm/aaaa) ===
        (function() {
            console.log('✅ SCRIPT DE MÁSCARA DE DATA INICIADO');

            const dateInputs = document.querySelectorAll('.date-mask');
            console.log('Campos de data detectados:', dateInputs.length);

            dateInputs.forEach(function(input) {
                // Converter valor inicial de yyyy-mm-dd para dd/mm/yyyy
                const initialValue = input.value;
                if (initialValue && initialValue.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    const [ano, mes, dia] = initialValue.split('-');
                    input.value = `${dia}/${mes}/${ano}`;
                    console.log(`✔️ Valor inicial convertido: ${initialValue} → ${input.value}`);
                }

                // Aplicar máscara ao digitar
                input.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, ''); // Remove não-dígitos
                    
                    if (value.length >= 2) {
                        value = value.substring(0, 2) + '/' + value.substring(2);
                    }
                    if (value.length >= 5) {
                        value = value.substring(0, 5) + '/' + value.substring(5, 9);
                    }
                    
                    e.target.value = value;
                });

                // Validar data ao sair do campo
                input.addEventListener('blur', function(e) {
                    const value = e.target.value;
                    if (value && value.length === 10) {
                        const partes = value.split('/');
                        if (partes.length === 3) {
                            const dia = parseInt(partes[0]);
                            const mes = parseInt(partes[1]);
                            const ano = parseInt(partes[2]);
                            
                            if (dia < 1 || dia > 31 || mes < 1 || mes > 12 || ano < 1900 || ano > 2100) {
                                alert('Data inválida! Use o formato dd/mm/aaaa');
                                e.target.value = '';
                                e.target.focus();
                            }
                        }
                    }
                });
            });

            console.log('✅ MÁSCARA DE DATA PRONTA');
        })();
    </script>
{% endblock %}

