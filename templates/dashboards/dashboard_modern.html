{% extends 'base_modern.html' %}

{% block title %}Dashboard - AGEMS{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">
        <i class="bi bi-speedometer2 me-2"></i>
        Dashboard
    </h1>
    <p class="page-subtitle">Visão geral do sistema de gestão regulatória</p>
</div>

<!-- Stats Cards -->
<div class="row g-4 mb-4">
    <div class="col-12 col-sm-6 col-xl-3">
        <div class="stat-card">
            <div class="stat-icon primary">
                <i class="bi bi-file-earmark-text"></i>
            </div>
            <div class="stat-value">{{ total_instrumentos }}</div>
            <div class="stat-label">Instrumentos Vigentes</div>
        </div>
    </div>
    
    <div class="col-12 col-sm-6 col-xl-3">
        <div class="stat-card">
            <div class="stat-icon success">
                <i class="bi bi-journal-check"></i>
            </div>
            <div class="stat-value">{{ total_obrigacoes }}</div>
            <div class="stat-label">Obrigações</div>
        </div>
    </div>
    
    <div class="col-12 col-sm-6 col-xl-3">
        <div class="stat-card">
            <div class="stat-icon warning">
                <i class="bi bi-hourglass-split"></i>
            </div>
            <div class="stat-value">{{ tarefas_a_vencer }}</div>
            <div class="stat-label">Tarefas a Vencer</div>
        </div>
    </div>
    
    <div class="col-12 col-sm-6 col-xl-3">
        <div class="stat-card">
            <div class="stat-icon danger">
                <i class="bi bi-clock-history"></i>
            </div>
            <div class="stat-value">{{ tarefas_vencidas }}</div>
            <div class="stat-label">Tarefas Vencidas</div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row g-4 mb-4">
    <div class="col-12 col-lg-8">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 py-3">
                <h5 class="card-title mb-0">
                    <i class="bi bi-graph-up me-2"></i>
                    Tarefas por Status
                </h5>
            </div>
            <div class="card-body">
                <canvas id="tarefasChart" height="80"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-12 col-lg-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 py-3">
                <h5 class="card-title mb-0">
                    <i class="bi bi-pie-chart me-2"></i>
                    Distribuição por Tipo
                </h5>
            </div>
            <div class="card-body">
                <canvas id="tiposChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Tables Row -->
<div class="row g-4">
    <div class="col-12 col-xl-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 py-3">
                <h5 class="card-title mb-0">
                    <i class="bi bi-list-check me-2"></i>
                    Obrigações Pendentes
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Obrigação</th>
                                <th>Instrumento</th>
                                <th>Vencimento</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for obrigacao in obrigacoes_pendentes %}
                            <tr>
                                <td>
                                    <div class="fw-semibold">{{ obrigacao.titulo }}</div>
                                    <small class="text-muted">{{ obrigacao.tipo_obrigacao }}</small>
                                </td>
                                <td>{{ obrigacao.instrumento.numero }}</td>
                                <td>
                                    <small class="text-muted">
                                        <i class="bi bi-calendar me-1"></i>
                                        {{ obrigacao.data_vencimento|date:"d/m/Y" }}
                                    </small>
                                </td>
                                <td>
                                    {% if obrigacao.status == 'pendente' %}
                                        <span class="badge bg-warning">Pendente</span>
                                    {% elif obrigacao.status == 'em_andamento' %}
                                        <span class="badge bg-info">Em Andamento</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ obrigacao.get_status_display }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center text-muted py-4">
                                    <i class="bi bi-check-circle fs-1 d-block mb-2"></i>
                                    Nenhuma obrigação pendente
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-12 col-xl-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 py-3">
                <h5 class="card-title mb-0">
                    <i class="bi bi-lightning me-2"></i>
                    Ações Recentes
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Ação</th>
                                <th>Responsável</th>
                                <th>Progresso</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for acao in acoes_recentes %}
                            <tr>
                                <td>
                                    <div class="fw-semibold">{{ acao.nome }}</div>
                                    <small class="text-muted">{{ acao.tipo_acao }}</small>
                                </td>
                                <td>
                                    <small>{{ acao.responsavel.get_full_name }}</small>
                                </td>
                                <td>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar" role="progressbar" 
                                             style="width: {{ acao.percentual_cumprido }}%"
                                             aria-valuenow="{{ acao.percentual_cumprido }}" 
                                             aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                    <small class="text-muted">{{ acao.percentual_cumprido }}%</small>
                                </td>
                                <td>
                                    {% if acao.status == 'finalizado' %}
                                        <span class="badge bg-success">Finalizado</span>
                                    {% elif acao.status == 'em_andamento' %}
                                        <span class="badge bg-primary">Em Andamento</span>
                                    {% elif acao.status == 'atrasado' %}
                                        <span class="badge bg-danger">Atrasado</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ acao.get_status_display }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center text-muted py-4">
                                    <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                    Nenhuma ação cadastrada
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // --- Gráfico de Tarefas por Status ---
    const tarefasData = JSON.parse('{{ tarefas_por_status|safe|escapejs }}');
    const labelMap = {
        "a_iniciar": "A Iniciar",
        "em_andamento": "Em Andamento",
        "atrasado": "Atrasado",
        "em_validacao": "Em Validação",
        "finalizado": "Finalizado"
    };

    const labels = tarefasData.map(t => labelMap[t.status] || t.status);
    const valores = tarefasData.map(t => t.total);

    const tarefasCtx = document.getElementById('tarefasChart');
    if (tarefasCtx) {
        new Chart(tarefasCtx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Quantidade de Tarefas',
                    data: valores,
                    backgroundColor: [
                        'rgba(245, 124, 0, 0.8)',   // A iniciar
                        'rgba(25, 118, 210, 0.8)', // Em andamento
                        'rgba(198, 40, 40, 0.8)',  // Atrasado
                        'rgba(106, 27, 154, 0.8)', // Em validação
                        'rgba(46, 125, 50, 0.8)'   // Finalizado
                    ],
                    borderColor: [
                        'rgb(245, 124, 0)',
                        'rgb(25, 118, 210)',
                        'rgb(198, 40, 40)',
                        'rgb(106, 27, 154)',
                        'rgb(46, 125, 50)'
                    ],
                    borderWidth: 2,
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { display: true, drawBorder: false }
                    },
                    x: {
                        grid: { display: false }
                    }
                }
            }
        });
    }
</script>

<script>
    // --- Gráfico de Instrumentos por Tipo ---
    const tiposData = JSON.parse('{{ instrumentos_por_tipo|safe|escapejs }}');
    const tipoLabels = tiposData.map(t => t.tipo_instrumento__nome);
    const tipoValores = tiposData.map(t => t.total);

    const tiposCtx = document.getElementById('tiposChart');
    if (tiposCtx && tiposData.length) {
        new Chart(tiposCtx, {
            type: 'doughnut',
            data: {
                labels: tipoLabels,
                datasets: [{
                    data: tipoValores,
                    backgroundColor: [
                        'rgba(13, 110, 253, 0.8)',
                        'rgba(118, 75, 162, 0.8)',
                        'rgba(25, 135, 84, 0.8)',
                        'rgba(255, 193, 7, 0.8)',
                        'rgba(220, 53, 69, 0.8)',
                        'rgba(102, 126, 234, 0.8)'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { color: '#333', font: { size: 13 } }
                    },
                    title: { display: false }
                }
            }
        });
    } else {
        document.getElementById('tiposChart').outerHTML =
            "<p class='text-center text-muted mt-3'>Sem dados de tipos de instrumentos.</p>";
    }
</script>
{% endblock %}
