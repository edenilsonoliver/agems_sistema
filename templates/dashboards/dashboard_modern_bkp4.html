{% extends 'base_modern.html' %}

{% block title %}Dashboard - AGEMS{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">
        <i class="bi bi-speedometer2 me-2"></i>
        Dashboard
    </h1>
    <p class="page-subtitle">Visão geral do sistema de gestão regulatória</p>
</div>

<!-- Stats Cards -->
<div class="row g-4 mb-4">
    <div class="col-12 col-sm-6 col-xl-3">
        <div class="stat-card">
            <div class="stat-icon primary">
                <i class="bi bi-file-earmark-text"></i>
            </div>
            <div class="stat-value">{{ total_instrumentos }}</div>
            <div class="stat-label">Instrumentos Vigentes</div>
        </div>
    </div>
    
    <div class="col-12 col-sm-6 col-xl-3">
        <div class="stat-card">
            <div class="stat-icon success">
                <i class="bi bi-journal-check"></i>
            </div>
            <div class="stat-value">{{ total_obrigacoes }}</div>
            <div class="stat-label">Obrigações</div>
        </div>
    </div>
    
    <div class="col-12 col-sm-6 col-xl-3">
        <div class="stat-card">
            <div class="stat-icon warning">
                <i class="bi bi-hourglass-split"></i>
            </div>
            <div class="stat-value">{{ tarefas_a_vencer }}</div>
            <div class="stat-label">Tarefas a Vencer</div>
        </div>
    </div>
    
    <div class="col-12 col-sm-6 col-xl-3">
        <div class="stat-card">
            <div class="stat-icon danger">
                <i class="bi bi-clock-history"></i>
            </div>
            <div class="stat-value">{{ tarefas_vencidas }}</div>
            <div class="stat-label">Tarefas Vencidas</div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row g-4 mb-4">
    <div class="col-12 col-lg-8">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 py-3">
                <h5 class="card-title mb-0">
                    <i class="bi bi-graph-up me-2"></i>
                    Tarefas por Status
                </h5>
            </div>
            <div class="card-body">
                <canvas id="tarefasChart" height="80"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-12 col-lg-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 py-3">
                <h5 class="card-title mb-0">
                    <i class="bi bi-pie-chart me-2"></i>
                    Distribuição por Tipo
                </h5>
            </div>
            <div class="card-body">
                <canvas id="tiposChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Tables Row -->
<div class="row g-4">
    <div class="col-12 col-xl-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 py-3">
                <h5 class="card-title mb-0">
                    <i class="bi bi-list-check me-2"></i>
                    Obrigações
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Instrumento da Ação</th>
                                <th>Ação</th>
                                <th>Obrigação</th>
                                <th>Vencimento</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for obrigacao in obrigacoes_usuario %}
                            <tr>
                                <td>
                                    <small>{{ obrigacao.instrumento.numero }}</small>
                                </td>
                                <td>
                                    {% with acao=obrigacao.acoes.first %}
                                    {% if acao %}
                                        <div class="fw-semibold">{{ acao.nome }}</div>
                                        <small class="text-muted">{{ acao.tipo_acao }}</small>
                                    {% else %}
                                        <small class="text-muted">-</small>
                                    {% endif %}
                                    {% endwith %}
                                </td>
                                <td>
                                    <div class="fw-semibold">{{ obrigacao.titulo }}</div>
                                    <small class="text-muted">{{ obrigacao.tipo_obrigacao }}</small>
                                </td>
                                <td>
                                    {% if obrigacao.data_vencimento %}
                                    <small class="text-muted">
                                        <i class="bi bi-calendar me-1"></i>
                                        {{ obrigacao.data_vencimento|date:"d/m/Y" }}
                                    </small>
                                    {% else %}
                                    <small class="text-muted">-</small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if obrigacao.status == 'pendente' %}
                                        <span class="badge bg-warning">Pendente</span>
                                    {% elif obrigacao.status == 'em_andamento' %}
                                        <span class="badge bg-info">Em Andamento</span>
                                    {% elif obrigacao.status == 'cumprida' %}
                                        <span class="badge bg-success">Cumprida</span>
                                    {% elif obrigacao.status == 'vencida' %}
                                        <span class="badge bg-danger">Vencida</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ obrigacao.get_status_display }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center text-muted py-4">
                                    <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                    Nenhuma obrigação vinculada ao usuário
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-12 col-xl-6">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 py-3">
                <h5 class="card-title mb-0">
                    <i class="bi bi-lightning me-2"></i>
                    Ações Recentes
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Ação</th>
                                <th>Responsável</th>
                                <th>Progresso</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for acao in acoes_recentes %}
                            <tr>
                                <td>
                                    <div class="fw-semibold">{{ acao.nome }}</div>
                                    <small class="text-muted">{{ acao.tipo_acao }}</small>
                                </td>
                                <td>
                                    <small>{{ acao.responsavel.get_full_name }}</small>
                                </td>
                                <td>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar" role="progressbar" 
                                             style="width: {{ acao.percentual_cumprido }}%"
                                             aria-valuenow="{{ acao.percentual_cumprido }}" 
                                             aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                    <small class="text-muted">{{ acao.percentual_cumprido }}%</small>
                                </td>
                                <td>
                                    {% if acao.status == 'finalizado' %}
                                        <span class="badge bg-success">Finalizado</span>
                                    {% elif acao.status == 'em_andamento' %}
                                        <span class="badge bg-primary">Em Andamento</span>
                                    {% elif acao.status == 'atrasado' %}
                                        <span class="badge bg-danger">Atrasado</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ acao.get_status_display }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center text-muted py-4">
                                    <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                    Nenhuma ação cadastrada
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // --- Gráfico de Tarefas por Status ---
    try {
        const tarefasData = JSON.parse('{{ tarefas_por_status|safe|escapejs }}');
        console.log('Dados de tarefas:', tarefasData);
        
        const labelMap = {
            "a_iniciar": "A Iniciar",
            "em_andamento": "Em Andamento",
            "atrasado": "Atrasado",
            "em_validacao": "Em Validação",
            "finalizado": "Finalizado"
        };

        const tarefasCtx = document.getElementById('tarefasChart');
        
        // ✅ Mapa de cores por status (CORRETO!)
        const colorMap = {
            "a_iniciar": {
                bg: 'rgba(108, 117, 125, 0.8)',  // CINZA
                border: 'rgb(108, 117, 125)'
            },
            "em_andamento": {
                bg: 'rgba(13, 110, 253, 0.8)',   // AZUL
                border: 'rgb(13, 110, 253)'
            },
            "atrasado": {
                bg: 'rgba(220, 53, 69, 0.8)',    // VERMELHO
                border: 'rgb(220, 53, 69)'
            },
            "em_validacao": {
                bg: 'rgba(255, 193, 7, 0.8)',    // AMARELO
                border: 'rgb(255, 193, 7)'
            },
            "finalizado": {
                bg: 'rgba(25, 135, 84, 0.8)',    // VERDE
                border: 'rgb(25, 135, 84)'
            }
        };
        
        // ✅ TRATAMENTO: Verificar se há dados antes de criar o gráfico
        if (tarefasCtx && tarefasData && tarefasData.length > 0) {
            const labels = tarefasData.map(t => labelMap[t.status] || t.status);
            const valores = tarefasData.map(t => t.total);
            
            // ✅ Mapear cores corretamente para cada status
            const backgroundColors = tarefasData.map(t => colorMap[t.status]?.bg || 'rgba(108, 117, 125, 0.8)');
            const borderColors = tarefasData.map(t => colorMap[t.status]?.border || 'rgb(108, 117, 125)');

            new Chart(tarefasCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Quantidade de Tarefas',
                        data: valores,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,  // ✅ Força incrementos de 1 em 1
                                precision: 0   // ✅ Sem casas decimais
                            },
                            grid: { display: true, drawBorder: false }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        } else {
            // ✅ TRATAMENTO: Mostrar mensagem quando não há tarefas
            console.warn('Nenhuma tarefa encontrada para o gráfico');
            if (tarefasCtx) {
                const parent = tarefasCtx.parentElement;
                parent.innerHTML = `
                    <div class="text-center text-muted py-5">
                        <i class="bi bi-inbox fs-1 d-block mb-3"></i>
                        <p class="mb-0">Nenhuma tarefa cadastrada ainda</p>
                        <small class="text-muted">Crie tarefas para visualizar o gráfico</small>
                    </div>
                `;
            }
        }
    } catch (error) {
        console.error('Erro ao criar gráfico de tarefas:', error);
        const tarefasCtx = document.getElementById('tarefasChart');
        if (tarefasCtx) {
            const parent = tarefasCtx.parentElement;
            parent.innerHTML = `
                <div class="text-center text-danger py-5">
                    <i class="bi bi-exclamation-triangle fs-1 d-block mb-3"></i>
                    <p class="mb-0">Erro ao carregar gráfico</p>
                    <small class="text-muted">Verifique o console para mais detalhes</small>
                </div>
            `;
        }
    }
</script>

<script>
    // --- Gráfico de Instrumentos por Tipo ---
    try {
        const tiposData = JSON.parse('{{ instrumentos_por_tipo|safe|escapejs }}');
        console.log('Dados de tipos:', tiposData);
        
        const tiposCtx = document.getElementById('tiposChart');
        
        // ✅ TRATAMENTO: Verificar se há dados antes de criar o gráfico
        if (tiposCtx && tiposData && tiposData.length > 0) {
            const tipoLabels = tiposData.map(t => t.tipo_instrumento__nome || 'Sem tipo');
            const tipoValores = tiposData.map(t => t.total);

            new Chart(tiposCtx, {
                type: 'doughnut',
                data: {
                    labels: tipoLabels,
                    datasets: [{
                        data: tipoValores,
                        backgroundColor: [
                            'rgba(13, 110, 253, 0.8)',
                            'rgba(118, 75, 162, 0.8)',
                            'rgba(25, 135, 84, 0.8)',
                            'rgba(255, 193, 7, 0.8)',
                            'rgba(220, 53, 69, 0.8)',
                            'rgba(102, 126, 234, 0.8)'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#333', font: { size: 13 } }
                        },
                        title: { display: false }
                    }
                }
            });
        } else {
            // ✅ TRATAMENTO: Mostrar mensagem quando não há instrumentos
            console.warn('Nenhum instrumento encontrado para o gráfico');
            if (tiposCtx) {
                const parent = tiposCtx.parentElement;
                parent.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-inbox fs-3 d-block mb-2"></i>
                        <p class="mb-0 small">Nenhum instrumento cadastrado</p>
                    </div>
                `;
            }
        }
    } catch (error) {
        console.error('Erro ao criar gráfico de tipos:', error);
        const tiposCtx = document.getElementById('tiposChart');
        if (tiposCtx) {
            const parent = tiposCtx.parentElement;
            parent.innerHTML = `
                <div class="text-center text-danger py-4">
                    <i class="bi bi-exclamation-triangle fs-3 d-block mb-2"></i>
                    <p class="mb-0 small">Erro ao carregar gráfico</p>
                </div>
            `;
        }
    }
</script>
{% endblock %}

